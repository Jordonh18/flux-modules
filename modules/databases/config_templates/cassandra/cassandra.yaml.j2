# Cassandra Configuration Template
# Generated by Flux Databases Module
# Memory: {{ memory_mb }}MB | CPUs: {{ cpus }} | Storage: {{ storage_gb }}GB

# Cluster Settings
cluster_name: 'flux-cassandra-{{ database_name }}'
num_tokens: 256
allocate_tokens_for_local_replication_factor: 3

# Directories
data_file_directories:
    - {{ data_dir }}/data
commitlog_directory: {{ data_dir }}/commitlog
saved_caches_directory: {{ data_dir }}/saved_caches
hints_directory: {{ data_dir }}/hints

# Network Settings
listen_address: 0.0.0.0
rpc_address: 0.0.0.0
broadcast_rpc_address: 0.0.0.0
start_native_transport: true
native_transport_port: {{ port }}
storage_port: {{ port + 100 }}
ssl_storage_port: {{ port + 101 }}

# Seeds (single-node setup)
seed_provider:
    - class_name: org.apache.cassandra.locator.SimpleSeedProvider
      parameters:
          - seeds: "127.0.0.1"

# Endpoint Snitch
endpoint_snitch: SimpleSnitch

# Memory Settings
memtable_heap_space_in_mb: {{ (memory_mb * 0.25)|int }}
memtable_offheap_space_in_mb: {{ (memory_mb * 0.25)|int }}

# Commitlog Settings
commitlog_sync: periodic
commitlog_sync_period_in_ms: 10000
commitlog_segment_size_in_mb: 32
commitlog_total_space_in_mb: {{ (storage_gb * 1024 * 0.25)|int }}

# Disk Settings
concurrent_reads: {{ (cpus * 16)|int }}
concurrent_writes: {{ (cpus * 8)|int }}
concurrent_counter_writes: {{ (cpus * 8)|int }}
concurrent_materialized_view_writes: {{ (cpus * 8)|int }}

# Compaction Settings
concurrent_compactors: {{ (cpus / 2)|int if cpus > 1 else 1 }}
compaction_throughput_mb_per_sec: 64
sstable_preemptive_open_interval_in_mb: 50

# Cache Settings
key_cache_size_in_mb: {{ (memory_mb * 0.05)|int }}
key_cache_save_period: 14400
row_cache_size_in_mb: 0
row_cache_save_period: 0
counter_cache_size_in_mb: {{ (memory_mb * 0.025)|int }}
counter_cache_save_period: 7200

# Index Settings
index_summary_capacity_in_mb: {{ (memory_mb * 0.05)|int }}
index_summary_resize_interval_in_minutes: 60

# Memtable Settings
memtable_allocation_type: heap_buffers
memtable_cleanup_threshold: 0.5
file_cache_size_in_mb: {{ (memory_mb * 0.1)|int }}

# Timeouts
read_request_timeout_in_ms: 5000
range_request_timeout_in_ms: 10000
write_request_timeout_in_ms: 2000
counter_write_request_timeout_in_ms: 5000
cas_contention_timeout_in_ms: 1000
truncate_request_timeout_in_ms: 60000
request_timeout_in_ms: 10000
slow_query_log_timeout_in_ms: 500

# Internode Settings
internode_compression: dc
inter_dc_tcp_nodelay: false

# GC Settings (for JVM configuration)
# Set via JVM_OPTS:
# -Xms{{ (memory_mb * 0.5)|int }}M -Xmx{{ (memory_mb * 0.5)|int }}M
# -XX:+UseG1GC -XX:G1RSetUpdatingPauseTimePercent=5

# Consistency
hinted_handoff_enabled: true
max_hint_window_in_ms: 10800000
hinted_handoff_throttle_in_kb: 1024
max_hints_delivery_threads: {{ (cpus / 2)|int if cpus > 1 else 1 }}
hints_flush_period_in_ms: 10000

# Batch Settings
batch_size_warn_threshold_in_kb: 5
batch_size_fail_threshold_in_kb: 50
unlogged_batch_across_partitions_warn_threshold: 10

# Streaming Settings
stream_throughput_outbound_megabits_per_sec: 200
inter_dc_stream_throughput_outbound_megabits_per_sec: 200

# Native Transport
native_transport_max_threads: {{ (cpus * 8)|int }}
native_transport_max_frame_size_in_mb: 256

# RPC Settings
rpc_server_type: sync
rpc_min_threads: 16
rpc_max_threads: {{ (cpus * 16)|int }}
rpc_send_buff_size_in_bytes: 16384
rpc_recv_buff_size_in_bytes: 16384

# Thrift Settings
thrift_framed_transport_size_in_mb: 15
thrift_max_message_length_in_mb: 16

# Tombstone Settings
tombstone_warn_threshold: 1000
tombstone_failure_threshold: 100000

# Snapshot Settings
snapshot_before_compaction: false
auto_snapshot: true

# CQL Settings
column_index_size_in_kb: 64
column_index_cache_size_in_kb: 2

# Compaction Strategy
compaction_large_partition_warning_threshold_mb: 100

{% if tls_enabled %}
# TLS/SSL Configuration
client_encryption_options:
    enabled: true
    optional: false
    keystore: {{ tls_key_path }}
    keystore_password: {{ password }}
    require_client_auth: false
    truststore: {{ tls_cert_path }}
    truststore_password: {{ password }}
    protocol: TLS
    algorithm: SunX509
    store_type: JKS
    cipher_suites: [TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_256_CBC_SHA]

server_encryption_options:
    internode_encryption: all
    keystore: {{ tls_key_path }}
    keystore_password: {{ password }}
    truststore: {{ tls_cert_path }}
    truststore_password: {{ password }}
    protocol: TLS
    algorithm: SunX509
    store_type: JKS
    cipher_suites: [TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_256_CBC_SHA]
    require_client_auth: false
{% endif %}

# Authentication & Authorization
authenticator: PasswordAuthenticator
authorizer: CassandraAuthorizer
role_manager: CassandraRoleManager
roles_validity_in_ms: 2000
permissions_validity_in_ms: 2000
credentials_validity_in_ms: 2000

# Audit Logging
audit_logging_options:
    enabled: false

# Full Query Logging
full_query_logging_options:
    log_dir: {{ log_dir }}/fql
    roll_cycle: HOURLY
    block: true
    max_queue_weight: 268435456
    max_log_size: 17179869184

# Incremental Backup
incremental_backups: false

# CDC
cdc_enabled: false
cdc_total_space_in_mb: 4096
cdc_free_space_check_interval_ms: 250
