# Neo4j Configuration Template
# Generated by Flux Databases Module
# Memory: {{ memory_mb }}MB | CPUs: {{ cpus }} | Storage: {{ storage_gb }}GB

#*****************************************************************
# Server Configuration
#*****************************************************************

# Network connector configuration
server.default_listen_address=0.0.0.0
server.bolt.listen_address=0.0.0.0:{{ port }}
server.http.listen_address=0.0.0.0:{{ port + 1 }}
server.https.listen_address=0.0.0.0:{{ port + 2 }}

# Bolt connector
server.bolt.enabled=true
{% if tls_enabled %}
server.bolt.tls_level=REQUIRED
{% else %}
server.bolt.tls_level=DISABLED
{% endif %}

# HTTP Connector
server.http.enabled=true

# HTTPS Connector
{% if tls_enabled %}
server.https.enabled=true
server.bolt.tls.certificate={{ tls_cert_path }}
server.bolt.tls.key={{ tls_key_path }}
server.https.certificate={{ tls_cert_path }}
server.https.key={{ tls_key_path }}
{% else %}
server.https.enabled=false
{% endif %}

# Thread pool configuration
server.threads.worker_count={{ (cpus * 2)|int }}

#*****************************************************************
# Memory Settings
#*****************************************************************

# Java Heap Size
# Set via NEO4J_JAVA_OPTS environment variable:
# NEO4J_JAVA_OPTS=-Xms{{ (memory_mb * 0.3)|int }}m -Xmx{{ (memory_mb * 0.3)|int }}m

# Pagecache memory
# The amount of memory to use for mapping the store files.
server.memory.pagecache.size={{ (memory_mb * 0.5)|int }}m

# Heap settings
server.memory.heap.initial_size={{ (memory_mb * 0.3)|int }}m
server.memory.heap.max_size={{ (memory_mb * 0.3)|int }}m

# Transaction state memory allocation
server.memory.transaction.global_max_size={{ (memory_mb * 0.1)|int }}m
server.memory.transaction.max_size={{ (memory_mb * 0.05)|int }}m

#*****************************************************************
# Database Location
#*****************************************************************

server.directories.data={{ data_dir }}
server.directories.logs={{ log_dir }}
server.directories.run=/var/run/neo4j
server.directories.transaction.logs.root={{ data_dir }}/transactions
server.directories.dumps.root={{ data_dir }}/dumps

#*****************************************************************
# Logging Configuration
#*****************************************************************

# Log level
server.logs.debug.level=INFO
server.logs.http.level=INFO
server.logs.security.level=INFO

# Log rotation
server.logs.debug.rotation.size=20m
server.logs.debug.rotation.keep_number=7
server.logs.http.rotation.size=20m
server.logs.http.rotation.keep_number=5
server.logs.security.rotation.size=20m
server.logs.security.rotation.keep_number=7

# Query logging
db.logs.query.enabled=true
db.logs.query.threshold=1s
db.logs.query.parameter_logging_enabled=true
db.logs.query.time_logging_enabled=true
db.logs.query.allocation_logging_enabled=true
db.logs.query.page_logging_enabled=true
db.logs.query.rotation.size=20m
db.logs.query.rotation.keep_number=7

#*****************************************************************
# Transaction Settings
#*****************************************************************

db.transaction.timeout=60s
db.transaction.bookmark_ready_timeout=30s
db.transaction.concurrent.maximum={{ max_connections }}

#*****************************************************************
# Checkpointing
#*****************************************************************

db.checkpoint=PERIODIC
db.checkpoint.interval.time=15m
db.checkpoint.interval.tx=100000

#*****************************************************************
# Database Configuration
#*****************************************************************

# Default database
initial.dbms.default_database=neo4j

# Read-only mode
db.read_only=false

# Allow file URLs (for LOAD CSV)
server.directories.import={{ data_dir }}/import
dbms.security.allow_csv_import_from_file_urls=true

#*****************************************************************
# Security Configuration
#*****************************************************************

# Authentication and authorization
dbms.security.auth_enabled=true
dbms.security.auth_minimum_password_length=8

# Procedures
dbms.security.procedures.unrestricted=apoc.*,algo.*
dbms.security.procedures.allowlist=apoc.*,algo.*

#*****************************************************************
# Cypher Configuration
#*****************************************************************

# Query cache
server.db.query_cache_size={{ max_connections * 10 }}

# Cypher runtime
cypher.default_language_version=5
cypher.lenient_create_relationship=false

# Planner
cypher.planner=COST
cypher.statistics_divergence_threshold=0.75
cypher.min_replan_interval=10s

#*****************************************************************
# Bolt Configuration
#*****************************************************************

server.bolt.thread_pool_min_size={{ cpus|int }}
server.bolt.thread_pool_max_size={{ (cpus * 2)|int }}
server.bolt.thread_pool_keep_alive=5m

# Connection keep-alive
server.bolt.connection_keep_alive=1m
server.bolt.connection_keep_alive_for_requests=ALL

#*****************************************************************
# Metrics Configuration
#*****************************************************************

server.metrics.enabled=true
server.metrics.csv.enabled=false
server.metrics.csv.interval=3s
server.metrics.jmx.enabled=true
server.metrics.prefix=neo4j
server.metrics.filter=*

#*****************************************************************
# Performance Tuning
#*****************************************************************

# Store settings
db.relationship_grouping_threshold=50
db.index_sampling.background_enabled=true
db.index_sampling.sample_size_limit=1000000
db.index.fulltext.eventually_consistent=false

# I/O settings
db.checkpoint.iops.limit=-1

# Query execution
cypher.forbid_exhaustive_shortestpath=false
cypher.forbid_shortestpath_common_nodes=true

# Relationship types
db.relationship_grouping_threshold=50

#*****************************************************************
# Plugins
#*****************************************************************

# APOC configuration
dbms.security.procedures.unrestricted=apoc.*

# Allowed origins for CORS
server.http.enabled_transports=HTTP1_1,HTTP2

#*****************************************************************
# JVM Settings (via environment)
#*****************************************************************
# Set these via NEO4J_JAVA_OPTS:
# -XX:+UseG1GC
# -XX:+AlwaysPreTouch
# -XX:+UnlockExperimentalVMOptions
# -XX:+TrustFinalNonStaticFields
# -XX:+DisableExplicitGC
# -Djdk.tls.ephemeralDHKeySize=2048
# -Djdk.tls.rejectClientInitiatedRenegotiation=true
