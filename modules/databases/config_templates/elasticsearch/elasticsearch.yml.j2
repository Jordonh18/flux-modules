# Elasticsearch Configuration Template
# Generated by Flux Databases Module
# Memory: {{ memory_mb }}MB | CPUs: {{ cpus }} | Storage: {{ storage_gb }}GB

# Cluster Settings
cluster.name: flux-elasticsearch-{{ database_name }}
node.name: {{ database_name }}-node-1

# Node Roles
node.roles: [ master, data, ingest, ml ]

# Paths
path.data: {{ data_dir }}
path.logs: {{ log_dir }}

# Network Settings
network.host: 0.0.0.0
http.port: {{ port }}
transport.port: {{ port + 100 }}

# HTTP Settings
http.max_content_length: 100mb
http.compression: true
http.cors.enabled: false

# Discovery Settings (single-node cluster)
discovery.type: single-node

# Gateway Settings
gateway.recover_after_nodes: 1
gateway.expected_nodes: 1
gateway.recover_after_time: 5m

# Memory Settings
# NOTE: Heap size is set via ES_JAVA_OPTS environment variable:
# ES_JAVA_OPTS="-Xms{{ (memory_mb * 0.5)|int }}m -Xmx{{ (memory_mb * 0.5)|int }}m"
bootstrap.memory_lock: false
indices.memory.index_buffer_size: 10%
indices.memory.min_index_buffer_size: 48mb

# Thread Pool Settings
thread_pool.write.queue_size: 1000
thread_pool.search.queue_size: 1000
thread_pool.get.queue_size: 1000

# Index Settings
action.auto_create_index: true
action.destructive_requires_name: true

# Shard Allocation
cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: 85%
cluster.routing.allocation.disk.watermark.high: 90%
cluster.routing.allocation.disk.watermark.flood_stage: 95%

# Indexing Settings
indices.queries.cache.size: 10%
indices.fielddata.cache.size: 15%
indices.requests.cache.size: 2%

# Recovery Settings
indices.recovery.max_bytes_per_sec: 100mb
cluster.routing.allocation.node_concurrent_recoveries: {{ (cpus / 2)|int if cpus > 1 else 1 }}
cluster.routing.allocation.node_initial_primaries_recoveries: {{ cpus|int }}

# Search Settings
search.max_buckets: 65536
search.default_search_timeout: 30s

{% if tls_enabled %}
# TLS/SSL Configuration
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.key: {{ tls_key_path }}
xpack.security.transport.ssl.certificate: {{ tls_cert_path }}
xpack.security.transport.ssl.certificate_authorities: [ "{{ tls_cert_path }}" ]

xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.key: {{ tls_key_path }}
xpack.security.http.ssl.certificate: {{ tls_cert_path }}
xpack.security.http.ssl.certificate_authorities: [ "{{ tls_cert_path }}" ]
{% else %}
# Security (disabled without TLS)
xpack.security.enabled: false
{% endif %}

# Monitoring
xpack.monitoring.enabled: true
xpack.monitoring.collection.enabled: true
xpack.monitoring.collection.interval: 10s

# Machine Learning
xpack.ml.enabled: true
xpack.ml.max_machine_memory_percent: 30

# Watcher (alerting)
xpack.watcher.enabled: false

# Graph
xpack.graph.enabled: true

# Logging
logger.level: info
logger.org.elasticsearch.discovery: warn
logger.org.elasticsearch.cluster.service: warn

# Deprecation Logging
logger.deprecation.level: warn

# Slow Log Settings
index.search.slowlog.threshold.query.warn: 10s
index.search.slowlog.threshold.query.info: 5s
index.search.slowlog.threshold.query.debug: 2s
index.search.slowlog.threshold.query.trace: 500ms

index.search.slowlog.threshold.fetch.warn: 1s
index.search.slowlog.threshold.fetch.info: 800ms
index.search.slowlog.threshold.fetch.debug: 500ms
index.search.slowlog.threshold.fetch.trace: 200ms

index.indexing.slowlog.threshold.index.warn: 10s
index.indexing.slowlog.threshold.index.info: 5s
index.indexing.slowlog.threshold.index.debug: 2s
index.indexing.slowlog.threshold.index.trace: 500ms
