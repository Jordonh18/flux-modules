# MongoDB Configuration Template
# Generated by Flux Databases Module
# Memory: {{ memory_mb }}MB | CPUs: {{ cpus }} | Storage: {{ storage_gb }}GB

# Network Settings
net:
  port: {{ port }}
  bindIp: 0.0.0.0
  maxIncomingConnections: {{ max_connections }}
  compression:
    compressors: snappy,zstd,zlib
{% if tls_enabled %}
  tls:
    mode: requireTLS
    certificateKeyFile: {{ tls_cert_path }}
    CAFile: {{ tls_cert_path }}
    allowConnectionsWithoutCertificates: false
    allowInvalidCertificates: false
{% endif %}

# Storage Settings
storage:
  dbPath: {{ data_dir }}
  journal:
    enabled: true
    commitIntervalMs: 100
  directoryPerDB: true
  wiredTiger:
    engineConfig:
      cacheSizeGB: {{ (memory_mb * 0.5 / 1024)|round(1) }}
      journalCompressor: snappy
      directoryForIndexes: true
    collectionConfig:
      blockCompressor: snappy
    indexConfig:
      prefixCompression: true

# System Log
systemLog:
  destination: file
  path: {{ log_dir }}/mongod.log
  logAppend: true
  logRotate: reopen
  timeStampFormat: iso8601-utc
  component:
    accessControl:
      verbosity: 0
    command:
      verbosity: 0
    query:
      verbosity: 0
    replication:
      verbosity: 0
    storage:
      verbosity: 0

# Process Management
processManagement:
  fork: false
  pidFilePath: /var/run/mongodb/mongod.pid

# Security Settings
security:
  authorization: enabled
{% if tls_enabled %}
  clusterAuthMode: x509
{% endif %}

# Operation Profiling
operationProfiling:
  mode: slowOp
  slowOpThresholdMs: 100
  slowOpSampleRate: 1.0

# Replication
replication:
  oplogSizeMB: {{ (storage_gb * 1024 * 0.05)|int }}
  enableMajorityReadConcern: true

# Sharding (optional, can be enabled via replica set)
# sharding:
#   clusterRole: shardsvr

# Free Monitoring (disabled by default)
cloud:
  monitoring:
    free:
      state: off

# Set the default write concern
setParameter:
  maxNumActiveUserIndexBuilds: {{ cpus|int }}
  # Synchronous execution of index builds
  indexBuildRetry: true
  # Connection pool settings
  connPoolMaxConnsPerHost: {{ (max_connections / 10)|int }}
  # Replica set settings
  catchUpTimeoutMillis: 2000
